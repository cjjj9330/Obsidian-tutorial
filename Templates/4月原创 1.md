---
cssclass: dataview
总任务数: 18
当前完成数: 15
完成度: 83%

---

```dataviewjs
// 注意：这是一个交互式数据库视图 - 原创文章版本
// 数据库配置
const DB_CONFIG = {
  title: "原创文章数据库",
  folderPath: '"独立站运营/4月工作文件/4月原创文章"',
  enableStats: "true",
  predefinedOptions: {
    "Status": ["Not Started", "In Progress", "Done"]
  },
  columnsConfig: [
    {id: "filename", name: "文件名", property: "file.name"},
    {id: "status", name: "Status", property: "Status"},
    {id: "created", name: "创建日期", property: "file.cday"}
  ]
};

// 创建数据库视图
const pages = dv.pages(DB_CONFIG.folderPath).sort(p => p.file.name, 'asc');

// 如果启用了统计功能，计算统计数据
if (DB_CONFIG.enableStats === "true") {
    const totalTasks = pages.length;
    const completedTasks = pages.filter(p => p.Status === "Done").length;
    const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

    // 获取当前文件的属性值（用于比较）
    const currentFile = dv.current().file;
    const currentTotal = dv.current().总任务数;
    const currentCompleted = dv.current().当前完成数;
    const currentRate = dv.current().完成度;

    // 更新当前笔记的属性 - 使用MetaEdit插件而非直接赋值
    try {
        // 检查MetaEdit插件是否安装并启用
        if (app.plugins.plugins["metaedit"]) {
            const { update } = app.plugins.plugins["metaedit"].api;
            
            // 仅在值发生变化时更新属性
            let needsUpdate = false;
            
            if (currentTotal !== totalTasks) {
                update("总任务数", totalTasks, currentFile.path);
                needsUpdate = true;
            }
            
            if (currentCompleted !== completedTasks) {
                update("当前完成数", completedTasks, currentFile.path);
                needsUpdate = true;
            }
            
            const newRate = `${completionRate}%`;
            if (currentRate !== newRate) {
                update("完成度", newRate, currentFile.path);
                needsUpdate = true;
            }
            
            if (needsUpdate) {
                console.log("属性已通过MetaEdit更新");
            } else {
                console.log("属性未发生变化，无需更新");
            }
        } else {
            // 如果MetaEdit不可用，退回到旧方法（虽然可能不生效）
            if (currentTotal !== totalTasks) dv.current().总任务数 = totalTasks;
            if (currentCompleted !== completedTasks) dv.current().当前完成数 = completedTasks;
            if (currentRate !== `${completionRate}%`) dv.current().完成度 = `${completionRate}%`;
            
            console.log("MetaEdit插件未安装或未启用，使用备用方法更新属性");
        }
    } catch (error) {
        console.error("更新属性时出错:", error);
        // 出错时仍尝试直接赋值，但也仅在值变化时更新
        if (currentTotal !== totalTasks) dv.current().总任务数 = totalTasks;
        if (currentCompleted !== completedTasks) dv.current().当前完成数 = completedTasks;
        if (currentRate !== `${completionRate}%`) dv.current().完成度 = `${completionRate}%`;
    }
}

// 解析预定义的选项列表
const predefinedOptions = typeof DB_CONFIG.predefinedOptions === 'string' 
    ? JSON.parse(DB_CONFIG.predefinedOptions) 
    : DB_CONFIG.predefinedOptions;

// 解析列配置
const columnsConfig = typeof DB_CONFIG.columnsConfig === 'string' 
    ? JSON.parse(DB_CONFIG.columnsConfig) 
    : DB_CONFIG.columnsConfig;

// 处理列配置，添加display函数
const columns = columnsConfig.map(col => {
    return {
        ...col,
        display: p => {
            try {
                if (col.property.startsWith("file.")) {
                    if (col.property === "file.link") {
                        return p.file.link;
                    } else if (col.property === "file.name") {
                        return p.file.link;
                    } else if (col.property === "file.cday") {
                        return p.file.cday;
                    } else if (col.property === "file.mday") {
                        return p.file.mday;
                    } else {
                        const propPath = col.property.split(".");
                        let value = p;
                        for (const prop of propPath) {
                            value = value[prop];
                        }
                        return value || "-";
                    }
                } else {
                    return p[col.property] || "-";
                }
            } catch (e) {
                return "-";
            }
        }
    };
});

// 创建筛选控件
const container = this.container;

// 添加CSS样式
const style = document.createElement('style');
style.textContent = `
.notion-db-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--background-modifier-border);
    padding-bottom: 10px;
}
.notion-db-title {
    font-size: 1.5em;
    font-weight: bold;
}
.notion-db-controls {
    display: flex;
    gap: 8px;
}
.dropdown {
    position: relative;
    display: inline-block;
}
.dropdown-content {
    display: none;
    position: absolute;
    background-color: var(--background-primary);
    min-width: 200px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    padding: 8px 0;
    z-index: 1;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
}
.dropdown-content.show {
    display: block;
}
.filter-item {
    padding: 8px 12px;
    cursor: pointer;
}
.filter-item:hover {
    background-color: var(--background-secondary);
}
.filter-select {
    padding: 8px 12px;
    border: none;
    width: 100%;
    background-color: var(--background-primary);
    color: var(--text-normal);
    cursor: pointer;
}
.filter-option-group {
    margin-top: 6px;
}
.filter-pill {
    display: inline-flex;
    align-items: center;
    background-color: var(--background-secondary);
    border-radius: 16px;
    padding: 4px 10px;
    margin-right: 8px;
    margin-bottom: 8px;
    font-size: 0.9em;
}
.filter-pill-close {
    margin-left: 6px;
    cursor: pointer;
    font-weight: bold;
}
.filter-container {
    margin-bottom: 15px;
}
.db-button {
    background-color: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}
.db-button:hover {
    background-color: var(--background-secondary-alt);
}
.sort-direction {
    margin-left: 4px;
}
.applied-filters {
    display: flex;
    flex-wrap: wrap;
    margin-bottom: 10px;
}
`;
container.appendChild(style);

// 创建数据库标题和控件区域
const headerDiv = container.createEl("div", {cls: "notion-db-header"});
headerDiv.createEl("div", {cls: "notion-db-title", text: DB_CONFIG.title});

const controlsDiv = headerDiv.createEl("div", {cls: "notion-db-controls"});

// 创建排序按钮
const sortDropdown = controlsDiv.createEl("div", {cls: "dropdown"});
const sortButton = sortDropdown.createEl("button", {cls: "db-button"});
sortButton.innerHTML = `<span>排序</span>`;
const sortContent = sortDropdown.createEl("div", {cls: "dropdown-content"});

// 创建筛选按钮
const filterDropdown = controlsDiv.createEl("div", {cls: "dropdown"});
const filterButton = filterDropdown.createEl("button", {cls: "db-button"});
filterButton.innerHTML = `<span>+ Filter</span>`;
const filterContent = filterDropdown.createEl("div", {cls: "dropdown-content"});

// 当前筛选和排序状态
let currentFilters = [];
let currentSort = {
    column: "filename",
    ascending: true
};

// 添加排序选项
columns.forEach(column => {
    const sortItem = sortContent.createEl("div", {cls: "filter-item"});
    sortItem.textContent = column.name + " ↑";
    sortItem.addEventListener("click", () => {
        currentSort = {
            column: column.id,
            ascending: true
        };
        updateSortButtonText();
        renderTable();
        sortContent.classList.remove("show");
    });
    
    const sortItemDesc = sortContent.createEl("div", {cls: "filter-item"});
    sortItemDesc.textContent = column.name + " ↓";
    sortItemDesc.addEventListener("click", () => {
        currentSort = {
            column: column.id,
            ascending: false
        };
        updateSortButtonText();
        renderTable();
        sortContent.classList.remove("show");
    });
});

// 添加筛选字段选项
columns.forEach(column => {
    const filterItem = filterContent.createEl("div", {cls: "filter-item"});
    filterItem.textContent = column.name;
    filterItem.addEventListener("click", () => {
        showFilterOptionsForColumn(column);
        filterContent.classList.remove("show");
    });
});

// 显示列筛选选项
function showFilterOptionsForColumn(column) {
    // 创建一个模态对话框
    const modal = document.createElement("div");
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100%";
    modal.style.height = "100%";
    modal.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
    modal.style.display = "flex";
    modal.style.justifyContent = "center";
    modal.style.alignItems = "center";
    modal.style.zIndex = "1000";
    
    const dialog = document.createElement("div");
    dialog.style.backgroundColor = "var(--background-primary)";
    dialog.style.padding = "20px";
    dialog.style.borderRadius = "8px";
    dialog.style.width = "350px";
    dialog.style.maxHeight = "80%";
    dialog.style.overflowY = "auto";
    
    const header = document.createElement("div");
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.marginBottom = "15px";
    
    const title = document.createElement("h3");
    title.textContent = `筛选: ${column.name}`;
    title.style.margin = "0";
    
    const closeBtn = document.createElement("button");
    closeBtn.textContent = "×";
    closeBtn.style.background = "none";
    closeBtn.style.border = "none";
    closeBtn.style.fontSize = "1.5em";
    closeBtn.style.cursor = "pointer";
    closeBtn.onclick = () => document.body.removeChild(modal);
    
    header.appendChild(title);
    header.appendChild(closeBtn);
    dialog.appendChild(header);
    
    // 获取该列所有可能的值
    let values = [];
    
    // 先检查是否有预定义选项
    if (predefinedOptions[column.property]) {
        // 使用预定义选项 + 从现有数据中提取的选项（合并去重）
        const existingValues = getExistingValues(column.property);
        values = [...new Set([...predefinedOptions[column.property], ...existingValues])];
    } else {
        // 从现有数据中提取值
        values = getExistingValues(column.property);
    }
    
    // 从现有数据中提取属性值
    function getExistingValues(property) {
        try {
            return [...new Set(pages.map(p => {
                try {
                    if (property.startsWith("file.")) {
                        const propPath = property.split(".");
                        let value = p;
                        for (const prop of propPath) {
                            value = value[prop];
                        }
                        return value;
                    } else {
                        return p[property];
                    }
                } catch (e) {
                    return null;
                }
            }).filter(v => v !== null && v !== undefined && v !== ""))];
        } catch (e) {
            console.error("获取列值错误:", e);
            return [];
        }
    }
    
    // 创建选项
    const select = document.createElement("select");
    select.className = "filter-select";
    select.style.width = "100%";
    select.style.marginBottom = "15px";
    
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "选择筛选条件...";
    select.appendChild(defaultOption);
    
    const equalOption = document.createElement("option");
    equalOption.value = "equals";
    equalOption.textContent = "等于";
    select.appendChild(equalOption);
    
    const containsOption = document.createElement("option");
    containsOption.value = "contains";
    containsOption.textContent = "包含";
    select.appendChild(containsOption);
    
    dialog.appendChild(select);
    
    // 值输入区域
    const inputArea = document.createElement("div");
    inputArea.className = "filter-option-group";
    
    const valueSelect = document.createElement("select");
    valueSelect.style.width = "100%";
    valueSelect.style.padding = "8px";
    valueSelect.style.marginBottom = "15px";
    valueSelect.style.display = "none"; // 初始隐藏
    
    // 添加选项
    const emptyOption = document.createElement("option");
    emptyOption.value = "";
    emptyOption.textContent = "选择一个值...";
    valueSelect.appendChild(emptyOption);
    
    // 对可能的值进行排序并添加到下拉菜单
    if (Array.isArray(values)) {
        values.sort().forEach(value => {
            if (value !== null && value !== undefined && value !== "") {
                const option = document.createElement("option");
                option.value = String(value);
                option.textContent = String(value);
                valueSelect.appendChild(option);
            }
        });
    }
    
    // 文本输入框
    const valueInput = document.createElement("input");
    valueInput.type = "text";
    valueInput.style.width = "100%";
    valueInput.style.padding = "8px";
    valueInput.style.marginBottom = "15px";
    valueInput.style.display = "none"; // 初始隐藏
    valueInput.placeholder = "输入筛选值...";
    
    inputArea.appendChild(valueSelect);
    inputArea.appendChild(valueInput);
    dialog.appendChild(inputArea);
    
    // 根据筛选条件显示不同的输入控件
    select.onchange = () => {
        valueSelect.style.display = "none";
        valueInput.style.display = "none";
        
        const selectedOption = select.value;
        if (!selectedOption) return;
        
        if (values.length > 0 && ["equals", "contains"].includes(selectedOption)) {
            valueSelect.style.display = "block";
        } else {
            valueInput.style.display = "block";
        }
    };
    
    // 添加按钮
    const buttonContainer = document.createElement("div");
    buttonContainer.style.display = "flex";
    buttonContainer.style.justifyContent = "flex-end";
    buttonContainer.style.gap = "10px";
    
    const cancelBtn = document.createElement("button");
    cancelBtn.textContent = "取消";
    cancelBtn.className = "db-button";
    cancelBtn.onclick = () => document.body.removeChild(modal);
    
    const applyBtn = document.createElement("button");
    applyBtn.textContent = "应用";
    applyBtn.className = "db-button";
    applyBtn.style.backgroundColor = "var(--interactive-accent)";
    applyBtn.style.color = "var(--text-on-accent)";
    
    applyBtn.onclick = () => {
        const condition = select.value;
        let value;
        
        if (valueSelect.style.display === "block") {
            value = valueSelect.value;
        } else {
            value = valueInput.value;
        }
        
        if (condition && value) {
            // 添加新筛选条件
            currentFilters.push({
                column: column.id,
                columnName: column.name,
                condition,
                value
            });
            
            renderFilterPills();
            renderTable();
            document.body.removeChild(modal);
        } else {
            alert("请选择筛选条件和值");
        }
    };
    
    buttonContainer.appendChild(cancelBtn);
    buttonContainer.appendChild(applyBtn);
    dialog.appendChild(buttonContainer);
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
}

// 应用筛选条件过滤页面
function filterPages(pages) {
    if (currentFilters.length === 0) return pages;
    
    return pages.filter(page => {
        return currentFilters.every(filter => {
            const column = columns.find(c => c.id === filter.column);
            if (!column) return true;
            
            let pageValue;
            try {
                if (column.property.startsWith("file.")) {
                    const propPath = column.property.split(".");
                    let value = page;
                    for (const prop of propPath) {
                        value = value[prop];
                    }
                    pageValue = value;
                } else {
                    pageValue = page[column.property];
                }
            } catch (e) {
                return false;
            }
            
            if (pageValue === undefined || pageValue === null) return false;
            
            // 转换为字符串进行比较
            const stringValue = String(pageValue).toLowerCase();
            const filterValue = filter.value.toLowerCase();
            
            switch (filter.condition) {
                case "equals":
                    return stringValue === filterValue;
                case "contains":
                    return stringValue.includes(filterValue);
                default:
                    return true;
            }
        });
    });
}

// 显示当前应用的筛选条件
function renderFilterPills() {
    // 清除现有的筛选pills
    const existingPills = container.querySelector(".applied-filters");
    if (existingPills) {
        existingPills.remove();
    }
    
    if (currentFilters.length === 0) return;
    
    const pillsContainer = container.createEl("div", {cls: "applied-filters"});
    
    currentFilters.forEach((filter, index) => {
        const pill = pillsContainer.createEl("div", {cls: "filter-pill"});
        
        let conditionText;
        switch (filter.condition) {
            case "equals": conditionText = "等于"; break;
            case "contains": conditionText = "包含"; break;
            default: conditionText = filter.condition;
        }
        
        pill.textContent = `${filter.columnName} ${conditionText} ${filter.value}`;
        
        const closeBtn = pill.createEl("span", {cls: "filter-pill-close", text: "×"});
        closeBtn.addEventListener("click", () => {
            currentFilters.splice(index, 1);
            renderFilterPills();
            renderTable();
        });
    });
}

// 更新排序按钮文本
function updateSortButtonText() {
    const column = columns.find(c => c.id === currentSort.column);
    if (column) {
        sortButton.innerHTML = `<span>排序: ${column.name} ${currentSort.ascending ? '↑' : '↓'}</span>`;
    }
}

// 安全的排序函数，处理可能的空值
function safeSort(pages, sortFunc) {
    try {
        return pages.sort(sortFunc);
    } catch (error) {
        console.error("排序错误:", error);
        // 如果发生错误，回退到按文件名排序
        return pages.sort((a, b) => a.file.name.localeCompare(b.file.name));
    }
}

// 渲染表格函数
function renderTable() {
    // 获取现有表格，如果存在则移除
    const existingTable = container.querySelector("table");
    if (existingTable) {
        existingTable.remove();
    }
    
    // 应用筛选
    let filteredPages = pages;
    
    if (currentFilters.length > 0) {
        filteredPages = filterPages(filteredPages);
    }
    
    // 应用排序
    const sortFunc = getSortFunction(currentSort.column);
    const sortedPages = currentSort.ascending ? 
        safeSort([...filteredPages], sortFunc) : 
        safeSort([...filteredPages], sortFunc).reverse();
    
    try {
        // 创建表格
        dv.table(
            columns.map(col => col.name), 
            sortedPages.map(p => columns.map(col => {
                try {
                    return col.display(p);
                } catch (error) {
                    console.error(`显示错误 (${col.id}):`, error);
                    return "-";
                }
            }))
        );
    } catch (error) {
        console.error("表格渲染错误:", error);
        const errorDiv = container.createEl("div");
        errorDiv.innerHTML = `<p style="color: red">表格渲染出错: ${error.message}</p>`;
    }
}

// 获取排序函数
function getSortFunction(columnId) {
    switch(columnId) {
        case "filename":
            return (a, b) => (a?.file?.name || "").localeCompare(b?.file?.name || "");
        case "created":
            return (a, b) => (a?.file?.cday || 0) - (b?.file?.cday || 0);
        default:
            // 通用排序函数
            const column = columns.find(c => c.id === columnId);
            if (!column) return (a, b) => 0;
            
            const property = column.property;
            
            // 字符串类型属性
            return (a, b) => {
                let aVal, bVal;
                
                try {
                    if (property.startsWith("file.")) {
                        const propPath = property.split(".");
                        let valueA = a;
                        let valueB = b;
                        for (const prop of propPath) {
                            valueA = valueA?.[prop];
                            valueB = valueB?.[prop];
                        }
                        aVal = String(valueA || "");
                        bVal = String(valueB || "");
                    } else {
                        aVal = String(a?.[property] || "");
                        bVal = String(b?.[property] || "");
                    }
                } catch (e) {
                    aVal = "";
                    bVal = "";
                }
                
                return aVal.localeCompare(bVal);
            };
    }
}

// 点击排序按钮显示/隐藏排序选项
sortButton.addEventListener("click", event => {
    event.stopPropagation();
    sortContent.classList.toggle("show");
    filterContent.classList.remove("show");
});

// 点击筛选按钮显示/隐藏筛选选项
filterButton.addEventListener("click", event => {
    event.stopPropagation();
    filterContent.classList.toggle("show");
    sortContent.classList.remove("show");
});

// 点击其他地方关闭下拉菜单
document.addEventListener("click", () => {
    sortContent.classList.remove("show");
    filterContent.classList.remove("show");
});

// 初始渲染
updateSortButtonText();
renderTable();